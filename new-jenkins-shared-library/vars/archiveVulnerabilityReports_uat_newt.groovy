import java.text.SimpleDateFormat
import hudson.model.Actionable
import hudson.model.Result

def call(body) {
    def config = [:]
    body.resolveStrategy = Closure.DELEGATE_FIRST
    body.delegate = config
    body()

    def AGENT = config.AGENT ?: ''
    def REPORTS_PATTERN = config.REPORTS_PATTERN ?: 'vulnerability_count_acunetix.txt'

    try {
        podTemplate(
            nodeSelector: 'cloud.google.com/gke-nodepool=spot-node-pool-1',
            containers: [containerTemplate(name: 'jnlp', image: 'asia.gcr.io/common-infra-services/jenkins-agent-updated:mss-cli')],
            volumes: [hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock'),
                      persistentVolumeClaim(claimName: 'jenkinsagentpvc', mountPath: '/home/jenkins/agent', readOnly: false)
            ]) {
            node(POD_LABEL) {
                
                stage('Archive DAST Reports') {
                    container('jnlp') {
                        echo "=== Starting DAST Report Collection and Archiving ==="
                        
                        // Unstash DAST reports from previous stage
                        try {
                            unstash 'acunetix-reports'
                            echo "Successfully retrieved acunetix-reports"
                        } catch (Exception e) {
                            echo "Could not unstash acunetix-reports: ${e.message}"
                        }
                        
                        // Create dast_reports directory and copy files
                        sh """
                            mkdir -p dast_reports
                            
                            # Acunetix reports
                            cp -v acunetix_report.pdf dast_reports/ 2>/dev/null || echo "acunetix_report.pdf not found"
                            cp -v vulnerability_count_acunetix.txt dast_reports/ 2>/dev/null || echo "vulnerability_count_acunetix.txt not found"
                            
                            echo "Files in dast_reports directory:"
                            ls -lh dast_reports/ || echo "Directory is empty"
                        """

                        // Check if any files were collected
                        def filesCollected = sh(
                            script: "ls -A dast_reports/ | wc -l",
                            returnStdout: true
                        ).trim().toInteger()
                        
                        if (filesCollected > 0) {
                            echo "Collected ${filesCollected} DAST file(s)"
                            
                            // Create zip archive
                            try {
                                zip zipFile: 'dast_security_reports.zip', archive: false, dir: 'dast_reports'
                                echo "Created dast_security_reports.zip"
                            } catch (Exception e) {
                                echo "Failed to create zip archive: ${e.message}"
                            }
                        } else {
                            echo "No DAST report files were collected"
                        }

                        // Generate DAST summary report
                        try {
                            generateDASTSummaryReport()
                            echo "Generated DAST summary report"
                        } catch (Exception e) {
                            echo "Failed to generate DAST summary report: ${e.message}"
                        }
                        
                        // Archive vulnerability count report
                        try {
                            archiveArtifacts artifacts: REPORTS_PATTERN, allowEmptyArchive: true
                            echo "Archived DAST vulnerability count report"
                        } catch (Exception e) {
                            echo "Failed to archive vulnerability count report: ${e.message}"
                        }
                        
                        echo "=== DAST report archiving process completed ==="
                    }
                }
            }
        }
    } catch (Exception err) {
        echo "Error in Archive DAST Reports stage: ${err.message}"
        echo "Pipeline will continue despite archiving errors"
    }
}

def generateDASTSummaryReport() {
    try {
        def dateTime = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date())
        def summaryReport = """DAST SECURITY SCAN SUMMARY REPORT
========================================================================
Generated: ${dateTime}
Build: ${env.JOB_NAME} #${env.BUILD_NUMBER}
Pipeline: ${env.BUILD_URL}
========================================================================
"""

        // Add Acunetix summary if available
        if (fileExists('vulnerability_count_acunetix.txt')) {
            summaryReport += "\n" + readFile('vulnerability_count_acunetix.txt') + "\n"
            summaryReport += "------------------------------------------------------------------------\n"
            echo "Added Acunetix report to summary"
            
            // Calculate overall severity
            def severitySummary = calculateAcunetixSeverity()
            if (severitySummary) {
                summaryReport += "\n${severitySummary}\n"
            }
        } else {
            summaryReport += "\nNo Acunetix vulnerability report found.\n"
            echo "Acunetix vulnerability report not found"
        }

        // Add overall status
        summaryReport += "\nOVERALL BUILD STATUS: ${currentBuild.result ?: 'SUCCESS'}\n"
        summaryReport += "========================================================================\n"

        // Write summary report
        writeFile file: 'dast_summary_report.txt', text: summaryReport
        archiveArtifacts artifacts: 'dast_summary_report.txt', allowEmptyArchive: true
        echo "DAST Summary Report:\n${summaryReport}"
        
    } catch (Exception e) {
        echo "Error generating DAST summary report: ${e.message}"
    }
}

def calculateAcunetixSeverity() {
    try {
        def acunetixContent = readFile('vulnerability_count_acunetix.txt')
        
        def criticalCount = 0
        def highCount = 0
        def mediumCount = 0
        def lowCount = 0
        def infoCount = 0
        
        def criticalMatch = acunetixContent =~ /Critical:\s*(\d+)/
        def highMatch = acunetixContent =~ /High:\s*(\d+)/
        def mediumMatch = acunetixContent =~ /Medium:\s*(\d+)/
        def lowMatch = acunetixContent =~ /Low:\s*(\d+)/
        def infoMatch = acunetixContent =~ /Information:\s*(\d+)/
        
        if (criticalMatch) criticalCount = criticalMatch[0][1].toInteger()
        if (highMatch) highCount = highMatch[0][1].toInteger()
        if (mediumMatch) mediumCount = mediumMatch[0][1].toInteger()
        if (lowMatch) lowCount = lowMatch[0][1].toInteger()
        if (infoMatch) infoCount = infoMatch[0][1].toInteger()
        
        def total = criticalCount + highCount + mediumCount + lowCount + infoCount
        
        def summary = """DAST VULNERABILITY SUMMARY
Tool: Acunetix

SEVERITY COUNTS:
  Critical: ${criticalCount}
  High:     ${highCount}
  Medium:   ${mediumCount}
  Low:      ${lowCount}
  Info:     ${infoCount}
  ─────────────
  Total:    ${total}

RISK ASSESSMENT: ${getDASTRiskLevel(criticalCount, highCount, mediumCount)}
"""
        return summary
        
    } catch (Exception e) {
        echo "Error calculating Acunetix severity: ${e.message}"
        return null
    }
}

def getDASTRiskLevel(critical, high, medium) {
    if (critical >= 5) return "CRITICAL - Immediate remediation required"
    if (critical >= 1 || high >= 10) return "HIGH - Urgent security fixes needed"
    if (high >= 5) return "ELEVATED - Review and patch vulnerabilities"
    if (high >= 1 || medium >= 10) return "MODERATE - Plan security updates"
    if (medium >= 5) return "LOW-MODERATE - Monitor and address over time"
    return "LOW - Acceptable security posture"
}